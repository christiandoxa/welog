# Welog [![Go Test](https://github.com/christiandoxa/welog/actions/workflows/test.yml/badge.svg?branch=main)](https://github.com/christiandoxa/welog/actions/workflows/test.yml)

**Welog** is a structured logging library for Go applications, integrating with **ElasticSearch** and powered by [Logrus](https://github.com/sirupsen/logrus).  
It provides detailed request/response logging for **Fiber**, **Gin**, and **gRPC** (via go-grpc-middleware), covering
both server-side and client-side calls.

---

## Features

- üì¶ **Plug-and-play** middleware for Fiber, Gin, and gRPC interceptors
- üìù **Structured JSON logs** via Logrus
- üîç **Detailed request/response tracing** with latency and metadata
- üîó **ElasticSearch integration** for centralized log storage
- üéØ **Context-aware logging** for handlers
- üîÑ **Client request logging** for outbound HTTP calls
- üîå **gRPC interceptors** ready for go-grpc-middleware chains

---

## Installation

```bash
go get github.com/christiandoxa/welog
```

---

## Quick Start

```go
package main

import (
    "github.com/christiandoxa/welog"
    "github.com/gofiber/fiber/v2"
)

func main() {
    // 1. Configure ElasticSearch connection
	welog.SetConfig(welog.Config{
        ElasticIndex:    "my-logs",
        ElasticURL:      "http://localhost:9200",
        ElasticUsername: "elastic",
        ElasticPassword: "changeme",
    })

    // 2. Create Fiber app and attach Welog middleware
    app := fiber.New()
    app.Use(welog.NewFiber(fiber.Config{}))

    // Example route
    app.Get("/", func(c *fiber.Ctx) error {
        return c.JSON(fiber.Map{"message": "hello world"})
    })

    app.Listen(":3000")
}
```

---

## Configuration

Welog exposes `welog.Config` to store ElasticSearch connection details:

```go
type Config struct {
    ElasticIndex    string
    ElasticURL      string
    ElasticUsername string
    ElasticPassword string
}
```

Set it at application startup using:

```go
welog.SetConfig(welog.Config{
    ElasticIndex:    "my-logs",
    ElasticURL:      "http://localhost:9200",
    ElasticUsername: "elastic",
    ElasticPassword: "changeme",
})
```

### Environment Variables Used

| Variable             | Description              |
|----------------------|--------------------------|
| `ELASTIC_INDEX__`    | ElasticSearch index name |
| `ELASTIC_URL__`      | ElasticSearch base URL   |
| `ELASTIC_USERNAME__` | ElasticSearch username   |
| `ELASTIC_PASSWORD__` | ElasticSearch password   |

---

## Middleware Setup

### Fiber

```go
app := fiber.New()
app.Use(welog.NewFiber(fiber.Config{}))
```

### Gin

```go
router := gin.Default()
router.Use(welog.NewGin())
```

### gRPC

```go
import (
grpcmiddleware "github.com/grpc-ecosystem/go-grpc-middleware/v2"
"google.golang.org/grpc"
)

server := grpc.NewServer(
grpcmiddleware.WithUnaryServerChain(welog.NewGRPCUnary()),
grpcmiddleware.WithStreamServerChain(welog.NewGRPCStream()),
)
```

---

## Client Request Logging

Welog supports logging outbound HTTP requests from within your application.

### Fiber Example

```go
import (
    "time"
    "net/http"
    "github.com/christiandoxa/welog/pkg/model"
)

reqModel := model.TargetRequest{
    URL:         "https://example.com/api",
    Method:      "GET",
    ContentType: "application/json",
    Header:      map[string]interface{}{"Authorization": "Bearer token"},
    Body:        []byte(`{"param":"value"}`),
    Timestamp:   time.Now(),
}

resModel := model.TargetResponse{
    Header:  map[string]interface{}{"Content-Type": "application/json"},
    Body:    []byte(`{"status":"ok"}`),
    Status:  http.StatusOK,
    Latency: 200 * time.Millisecond,
}

welog.LogFiberClient(c, reqModel, resModel)
```

### Gin Example

```go
welog.LogGinClient(c, reqModel, resModel)
```

### gRPC Example

```go
welog.LogGRPCClient(ctx, reqModel, resModel)
```

---

## Logging Inside Handlers

Welog stores a contextual `*logrus.Entry` inside the request context.

### Fiber

```go
c.Locals("logger").(*logrus.Entry).Error("Something went wrong")
```

### Gin

```go
c.MustGet("logger").(*logrus.Entry).Error("Something went wrong")
```

### gRPC

```go
entry := ctx.Value("logger").(*logrus.Entry)
entry.Error("Something went wrong")
```

---

## Direct Logger Usage

Need a logger outside of HTTP/gRPC middleware? Use the singleton directly after configuring Welog (via `SetConfig` or
environment variables):

```go
import (
"github.com/christiandoxa/welog/pkg/infrastructure/logger"
)

func connectWithCache(dsn string) {
// your connection logic here...
logger.Logger().Info("Using cached connection for DSN:", dsn)
}
```

---

## Sample Output

Example JSON log entry generated by `logFiber`:

```json
{
  "level": "info",
  "requestAgent": "PostmanRuntime/7.31.1",
  "requestBody": {"foo": "bar"},
  "requestMethod": "POST",
  "requestUrl": "http://localhost/api/v1/resource",
  "requestTimestamp": "2024-09-25T12:34:56.789Z",
  "responseStatus": 200,
  "responseLatency": "150ms",
  "responseTimestamp": "2024-09-25T12:34:56.939Z",
  "target": [
    {
      "targetRequestMethod": "GET",
      "targetRequestURL": "https://example.com/api/data",
      "targetResponseStatus": 200,
      "targetResponseLatency": "200ms"
    }
  ]
}
```

---

## Contributing

Contributions are welcome! Please open an issue or submit a pull request.

---

## License

MIT License ‚Äî see [LICENSE](LICENSE) for details.
